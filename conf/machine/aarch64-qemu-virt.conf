#@TYPE: Machine
#@NAME: aarch64-qemu-virt
#@DESCRIPTION: ARMv8 QEMU virt machine for StarryOS/ArceOS

# ==================== 基础架构配置 ====================
require conf/machine/include/arm/armv8a/tune-cortexa57.inc
require conf/machine/include/qemu.inc
require conf/machine/include/arceos-machine-common.inc

# ==================== ArceOS/StarryOS 平台变量 ====================
ARCEOS_ARCH = "aarch64"
ARCEOS_PLATFORM = "aarch64-qemu-virt"
ARCEOS_PLAT_PACKAGE = "axplat-aarch64-qemu-virt"
RUST_TARGET = "aarch64-unknown-none-softfloat"
ARCEOS_USE_MYPLAT ?= "0"
ARCEOS_SMP ?= "4"
ARCEOS_MEM ?= "1G"

# ==================== QEMU 基础配置 ====================
QB_SYSTEM_NAME = "qemu-system-aarch64"
QB_MACHINE = "-machine virt"
QB_CPU = "-cpu cortex-a72"
QB_CPU_KVM = "-cpu host -machine gic-version=3"
QB_MEM = "-m ${ARCEOS_MEM}"
QB_SMP = "-smp ${ARCEOS_SMP}"
QB_DEFAULT_KERNEL = "starry.bin"
QB_SERIAL_OPT = "-nographic"

SERIAL_CONSOLES = "115200;ttyAMA0"

# ==================== QEMU 网络配置 ====================
QB_SLIRP_OPT = "-netdev user,id=net0,hostfwd=tcp::5555-:5555,hostfwd=udp::5555-:5555"
QB_NETWORK_DEVICE = "-device virtio-net-pci,netdev=net0,mac=@MAC@"
# 禁用内核命令行 IP 配置（StarryOS 使用内置 IP 配置）
QB_CMDLINE_IP_SLIRP = ""

# ==================== QEMU 块设备配置 ====================
QB_DRIVE_TYPE = "/dev/vda"
QB_ROOTFS_OPT = "-drive id=disk0,file=@ROOTFS@,if=none,format=raw -device virtio-blk-pci,drive=disk0"

# ==================== QEMU 显示/输入配置 ====================
# QB_GRAPHICS 会触发 runqemu 的 SDL 显示模式
# 如果 QEMU 没有 SDL 支持，需要禁用图形或使用其他显示方式
#
# 方式1：无图形模式（默认，通过串口交互）
# QB_GRAPHICS = ""
#
# 方式2：有图形模式（需要 SDL/VNC 支持）
# QB_GRAPHICS = "-device virtio-gpu-pci -display vnc=:0"
#
# 当前配置：无图形模式，但仍添加 virtio 输入设备供将来使用
QB_OPT_APPEND = "-device virtio-mouse-pci -device virtio-keyboard-pci"

# ==================== QEMU VSOCK 配置 ====================
# 对应 qemu.mk: VSOCK=y
# 注意：需要宿主机 /dev/vhost-vsock 且用户在 kvm 组中
QB_OPT_APPEND:append = " -device vhost-vsock-pci,id=virtiosocket0,guest-cid=103"
